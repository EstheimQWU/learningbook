# nginx
```
Nginx 是一款轻量级的 Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，其特点是占有内存少，并发能力强。

Nginx 因为它的稳定性、丰富的模块库、灵活的配置和低系统资源的消耗而闻名．业界一致认为它是 Apache2.2＋mod_proxy_balancer 的轻量级代替者，不仅是因为响应静态页面的速度非常快，而且它的模块数量达到 Apache 的近 2/3。
```
## 基础原理

Nginx 在启动后，在 unix 系统中会以 **daemon** 的方式在后台运行，后台进程包含一个 master 进程和多个 worker 进程。
我们也可以手动地关掉后台模式，让 Nginx 在前台运行，并且通过配置让 Nginx 取消 master 进程，从而可以使 Nginx 以单进程方式运行。

### 架构原理
#### 基础原理
启动nginx时会创建MASTER进程和WORKER进程，一般情况下Worker会根据计算机CPU的核数决定（由nginx架构原理中的异步非阻塞方式处理请求所决定的）。管理员通过管理master进程以间接管理worker进程。

首先 master 进程在接到信号后，会先重新加载配置文件，然后再启动新的 worker 进程，并向所有老的 worker 进程发送信号。新的 worker 在启动后，就开始接收新的请求，而老的 worker 在收到来自 master 的信号后，就不再接收新的请求，并且在当前进程中的所有未处理完的请求处理完成后，再退出。

每个 worker 进程都是从 master 进程 fork 过来，在 master 进程里面，先建立好需要 listen 的 socket（listenfd）之后，然后再 fork 出多个 worker 进程。

所有 worker 进程的 listenfd 会在新连接到来时变得可读，为保证只有一个进程处理该连接，所有 worker 进程在注册 listenfd 读事件前抢 accept_mutex，抢到互斥锁的那个进程注册 listenfd 读事件，在读事件里调用 accept 接受该连接。

当一个 worker 进程在 accept 这个连接之后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接，这样一个完整的请求就是这样的了。

一个请求，完全由 worker 进程来处理，而且只在一个 worker 进程中处理。

#### 异步非阻塞
阻塞调用的情况：在阻塞调用的时候，若是事件没有准备好，只能够等待事件准备完毕再继续。阻塞调用会进入内核等待，CPU资源就被浪费了，因此不适合单线程运行的worker。当网络事件增多时，资源一直处于空耗之中，因此无法实现高并发的需求。

而非阻塞的方式可以缓解这一情况，非阻塞的方式解决了空耗cpu的问题，再事件没有准备好的情况下，可以使得cpu资源先去处理其他事情。而非阻塞仅仅缓解了空耗cpu的问题，却没有解决开销依旧不小的问题。

这时候就诞生了异步非阻塞方法的事件处理机制。


> 当事件没准备好时，放到 epoll 里面，事件准备好了，我们就去读写，当读写返回 EAGAIN 时，我们将它再次加入到 epoll 里面。这样，只要有事件准备好了，我们就去处理它，只有当所有事件都没准备好时，才在 epoll 里面等着。

> 这里的并发请求，是指未处理完的请求，线程只有一个，所以同时能处理的请求当然只有一个了，只是在请求间进行不断地切换而已，切换也是因为异步事件未准备好，而主动让出的。

由于worker进程并不是多线程进程，因此盲目增加worker数量并没有好处，反而会导致进程来竞争 cpu 资源，从而带来不必要的上下文切换。

因此选择异步非阻塞。